<template>
  <div>
    <Portal to="primary-actions"></Portal>
    <div
      class="w-[calc(100vw-8px)] ml-[calc(50%-50vw+4px)] mr-[calc(50%-50vw+4px)] -mt-6 mb-10 rounded-b-xl bg-foundation transition shadow-md hover:shadow-xl divide-y divide-outline-3"
    >
      <div v-if="showChecklist">
        <OnboardingChecklistV1 show-intro />
      </div>
      <ProjectsInviteBanners
        v-if="projectsPanelResult?.activeUser?.projectInvites?.length"
        :invites="projectsPanelResult?.activeUser"
      />
      <ProjectsNewSpeckleBanner
        v-if="showNewSpeckleBanner"
        @dismissed="onDismissNewSpeckleBanner"
      />
    </div>

    <div
      class="p-8 bg-[#27272a] text-white rounded-xl w-full flex flex-col md:flex-row items-center gap-5 md:gap-6 mb-2 select-none"
    >
      <div>
        <svg
          viewBox="0 0 1170 156"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          class="h-10 lg:h-11"
        >
          <path
            d="M102.027 89.668C102.301 90.6836 102.438 91.6211 102.438 92.4805C102.438 92.7539 102.398 93.2227 102.32 93.8867C102.242 94.5508 102.086 95.293 101.852 96.1133L97.2227 112.344C96.2852 115.586 95.1328 118.125 93.7656 119.961C92.3984 121.797 90.9141 123.105 89.3125 123.887C87.7109 124.629 86.0508 125 84.332 125H52.8086L76.0703 43.9062H107.359C109.078 43.9062 110.543 44.3359 111.754 45.1953C112.965 46.0156 113.727 47.3438 114.039 49.1797C114.156 49.6875 114.215 50.2539 114.215 50.8789C114.215 52.4414 113.883 54.3359 113.219 56.5625L108.238 73.8477C108.121 74.3164 107.848 75.0391 107.418 76.0156C106.988 76.9922 106.383 77.9883 105.602 79.0039C104.859 79.9805 103.922 80.7422 102.789 81.2891C101.656 81.7578 100.543 82.1875 99.4492 82.5781C98.3555 82.9297 97.457 83.2031 96.7539 83.3984L95.582 83.6914L96.4609 84.2188C97.0078 84.5703 97.6719 85.0391 98.4531 85.625C99.2344 86.1719 99.957 86.7969 100.621 87.5C101.285 88.2031 101.754 88.9258 102.027 89.668ZM93.4727 76.0742L98.4531 58.7305H85.9141L80.9336 76.0742H93.4727ZM83.7461 110.176L89.6055 89.668H77.0664L71.207 110.176H83.7461ZM121.246 110.176H137.477L133.199 125H108.766C106.695 125 105.133 124.258 104.078 122.773C103.414 121.836 103.082 120.762 103.082 119.551C103.082 118.887 103.18 118.184 103.375 117.441L122.125 51.9922C122.828 49.6094 123.629 47.8516 124.527 46.7188C125.426 45.5469 126.402 44.7852 127.457 44.4336C128.551 44.082 129.664 43.9062 130.797 43.9062H156.461L152.184 58.7305H135.953L130.973 76.0742H146.852L138.355 89.668H127.105L121.246 110.176ZM190.738 43.9062H205.855L177.203 89.1406L166.949 125H151.188L161.441 89.3164L158.805 43.9062H173.922L174.625 70.8594L190.738 43.9062ZM192.32 125C190.367 125 188.902 124.297 187.926 122.891C187.34 122.07 187.047 121.094 187.047 119.961C187.047 119.141 187.184 118.242 187.457 117.266L206.148 52.0508C206.969 49.1602 208.258 47.0898 210.016 45.8398C211.773 44.5508 213.629 43.9062 215.582 43.9062H242.125C244.078 43.9062 245.562 44.5312 246.578 45.7812C247.125 46.4844 247.398 47.4414 247.398 48.6523C247.398 49.6289 247.223 50.7617 246.871 52.0508L228.18 117.266C227.477 119.648 226.227 121.543 224.43 122.949C222.672 124.316 220.816 125 218.863 125H192.32ZM216.109 110.176L230.816 58.7305H218.336L203.629 110.176H216.109ZM270.777 87.6758L283.316 43.9062H295.621L272.359 125H260.055L260.172 87.793L259.527 79.4141L256.422 88.4375L245.934 125H233.629L256.891 43.9062H270.016L270.777 87.6758ZM280.035 125L303.297 43.9062H334.82C336.5 43.9062 337.926 44.2969 339.098 45.0781C340.27 45.8594 341.012 47.1289 341.324 48.8867C341.441 49.3945 341.5 49.9609 341.5 50.5859C341.5 52.0312 341.188 53.7891 340.562 55.8594L323.98 113.75C322.848 117.656 321.129 120.508 318.824 122.305C316.52 124.102 313.863 125 310.855 125H280.035ZM310.914 110.176L325.621 58.7305H313.141L298.434 110.176H310.914ZM367.457 125L386.441 58.7305H375.602L379.879 43.9062H417.262L412.984 58.7305H402.203L383.219 125H367.457ZM440.758 76.0742L450.016 43.9062H464.137L440.875 125H426.754L436.891 89.668H424.41L414.273 125H400.152L423.414 43.9062H437.535L428.277 76.0742H440.758ZM468.59 110.176H484.82L480.543 125H456.109C454.039 125 452.477 124.258 451.422 122.773C450.758 121.836 450.426 120.762 450.426 119.551C450.426 118.887 450.523 118.184 450.719 117.441L469.469 51.9922C470.172 49.6094 470.973 47.8516 471.871 46.7188C472.77 45.5469 473.746 44.7852 474.801 44.4336C475.895 44.082 477.008 43.9062 478.141 43.9062H503.805L499.527 58.7305H483.297L478.316 76.0742H494.195L485.699 89.668H474.449L468.59 110.176ZM590.289 42.6172C590.172 43.0078 590.113 43.3594 590.113 43.6719C590.113 44.4922 590.406 45.1953 590.992 45.7812L619.059 71.2695C620.27 72.4805 620.875 73.9062 620.875 75.5469C620.875 76.2109 620.758 76.9336 620.523 77.7148L610.445 112.988C609.625 115.801 608.414 118.086 606.812 119.844C605.211 121.602 603.395 122.91 601.363 123.77C599.332 124.59 597.203 125 594.977 125H563.688C561.461 125 559.488 124.57 557.77 123.711C556.051 122.852 554.84 121.406 554.137 119.375C553.863 118.555 553.727 117.637 553.727 116.621C553.727 115.098 554.02 113.32 554.605 111.289L561.285 88.0859H579.391L573.238 108.77H593.805L600.426 86.3867C600.543 86.0352 600.602 85.6836 600.602 85.332C600.602 84.5117 600.27 83.8086 599.605 83.2227L571.773 59.1406C570.523 57.9297 569.898 56.5039 569.898 54.8633C569.898 54.1602 570.016 53.418 570.25 52.6367L579.508 20.4688C580.133 18.1641 581.109 16.0547 582.438 14.1406C583.805 12.2266 585.68 10.7031 588.062 9.57031C590.445 8.4375 593.57 7.87109 597.438 7.87109H627.438C629.742 7.87109 631.695 8.37891 633.297 9.39453C634.938 10.4102 636.012 12.0508 636.52 14.3164C636.676 14.9805 636.754 15.7227 636.754 16.543C636.754 18.4961 636.344 20.8398 635.523 23.5742L630.309 41.7969H612.203L617.359 24.1016H595.738L590.289 42.6172ZM591.988 146.211C597.73 146.211 603.219 145.41 608.453 143.809C613.688 142.246 618.531 140.039 622.984 137.188H636.52C630.66 142.578 623.922 146.797 616.305 149.844C608.727 152.891 600.641 154.414 592.047 154.414C582.984 154.414 574.488 152.734 566.559 149.375C558.668 146.055 551.734 141.445 545.758 135.547C539.781 129.688 535.113 122.891 531.754 115.156C528.395 107.422 526.695 99.082 526.656 90.1367C526.734 83.8867 527.574 77.9883 529.176 72.4414C531.129 65.6836 534.996 58.2227 540.777 50.0586C546.598 41.8945 555.641 35.3516 567.906 30.4297L564.918 40.8594C555.895 45.7422 549.371 51.4062 545.348 57.8516C541.324 64.2578 538.609 69.8633 537.203 74.668C535.797 79.5508 535.074 84.707 535.035 90.1367C535.035 97.9492 536.5 105.234 539.43 111.992C542.398 118.711 546.48 124.629 551.676 129.746C556.91 134.902 562.965 138.926 569.84 141.816C576.754 144.746 584.137 146.211 591.988 146.211ZM617.77 125L641.031 43.9062H673.316C675.66 43.9062 677.418 44.7266 678.59 46.3672C679.332 47.4219 679.703 48.6328 679.703 50C679.703 50.7422 679.586 51.543 679.352 52.4023L671.09 81.1719C670.426 83.5156 669.02 85.5273 666.871 87.207C664.762 88.8477 662.535 89.668 660.191 89.668H642.027L631.891 125H617.77ZM658.434 76.0742L663.414 58.7305H650.875L645.895 76.0742H658.434ZM686.207 110.176H702.438L698.16 125H673.727C671.656 125 670.094 124.258 669.039 122.773C668.375 121.836 668.043 120.762 668.043 119.551C668.043 118.887 668.141 118.184 668.336 117.441L687.086 51.9922C687.789 49.6094 688.59 47.8516 689.488 46.7188C690.387 45.5469 691.363 44.7852 692.418 44.4336C693.512 44.082 694.625 43.9062 695.758 43.9062H721.422L717.145 58.7305H700.914L695.934 76.0742H711.812L703.316 89.668H692.066L686.207 110.176ZM724.176 110.176H738.59L741.637 99.5117H755.055L750.543 115.098C749.84 117.598 748.902 119.57 747.73 121.016C746.559 122.461 745.23 123.496 743.746 124.121C742.301 124.707 740.797 125 739.234 125H714.332C712.77 125 711.422 124.707 710.289 124.121C709.195 123.496 708.453 122.461 708.062 121.016C707.945 120.547 707.887 120 707.887 119.375C707.887 118.203 708.121 116.777 708.59 115.098L726.285 53.5156C726.988 51.0938 727.906 49.1797 729.039 47.7734C730.172 46.3672 731.441 45.3711 732.848 44.7852C734.293 44.1992 735.777 43.9062 737.301 43.9062H762.73C764.254 43.9062 765.543 44.1992 766.598 44.7852C767.691 45.3711 768.414 46.3672 768.766 47.7734C768.883 48.2422 768.941 48.7695 768.941 49.3555C768.941 50.5273 768.707 51.9141 768.238 53.5156L764.02 68.2812H750.602L753.297 58.7305H738.883L724.176 110.176ZM808.316 43.9062H825.074L797.066 75.0195L800.875 125H784.117L781.422 92.3633L777.613 96.582L769.469 125H755.348L778.609 43.9062H792.73L785.816 68.0469L808.316 43.9062ZM843.707 43.9062L824.723 110.176H840.953L836.676 125H811.773C809.82 125 808.355 124.297 807.379 122.891C806.754 122.031 806.441 121.055 806.441 119.961C806.441 119.297 806.539 118.613 806.734 117.91L827.945 43.9062H843.707ZM862.457 110.176H878.688L874.41 125H849.977C847.906 125 846.344 124.258 845.289 122.773C844.625 121.836 844.293 120.762 844.293 119.551C844.293 118.887 844.391 118.184 844.586 117.441L863.336 51.9922C864.039 49.6094 864.84 47.8516 865.738 46.7188C866.637 45.5469 867.613 44.7852 868.668 44.4336C869.762 44.082 870.875 43.9062 872.008 43.9062H897.672L893.395 58.7305H877.164L872.184 76.0742H888.062L879.566 89.668H868.316L862.457 110.176ZM919.762 80.9375L934.703 43.9062H949.234L915.25 125H902.066L900.484 43.9062H916.832L915.133 90.8984L919.762 80.9375ZM951.52 110.176H967.75L963.473 125H939.039C936.969 125 935.406 124.258 934.352 122.773C933.688 121.836 933.355 120.762 933.355 119.551C933.355 118.887 933.453 118.184 933.648 117.441L952.398 51.9922C953.102 49.6094 953.902 47.8516 954.801 46.7188C955.699 45.5469 956.676 44.7852 957.73 44.4336C958.824 44.082 959.938 43.9062 961.07 43.9062H986.734L982.457 58.7305H966.227L961.246 76.0742H977.125L968.629 89.668H957.379L951.52 110.176ZM1014.04 83.75L1014.45 84.043C1014.57 84.082 1014.72 84.1406 1014.92 84.2188C1015.43 84.5703 1016.05 85.0195 1016.79 85.5664C1017.54 86.0742 1018.24 86.6406 1018.9 87.2656C1019.57 87.8906 1020.04 88.4961 1020.31 89.082C1020.62 89.9414 1020.78 90.8398 1020.78 91.7773C1020.78 92.0898 1020.74 92.6367 1020.66 93.418C1020.58 94.1602 1020.33 95.293 1019.9 96.8164L1011.81 125H997.691L1007.83 89.668H995.348L985.211 125H971.09L994.352 43.9062H1025.99C1027.67 43.9062 1029.08 44.3164 1030.21 45.1367C1031.34 45.918 1032.07 47.2266 1032.38 49.0625C1032.46 49.4922 1032.5 49.9609 1032.5 50.4688C1032.5 52.1094 1032.16 54.082 1031.5 56.3867L1026.23 74.7266C1026.03 75.3125 1025.72 76.0352 1025.29 76.8945C1024.9 77.7148 1024.39 78.5156 1023.77 79.2969C1023.14 80.0391 1022.4 80.625 1021.54 81.0547C1019.51 81.9531 1017.75 82.6172 1016.27 83.0469L1014.04 83.75ZM1011.7 76.0742L1016.68 58.7305H1004.2L999.215 76.0742H1011.7ZM1050.37 58.7305L1047.73 67.9297C1047.65 68.2031 1047.61 68.457 1047.61 68.6914C1047.61 69.2773 1047.83 69.7852 1048.26 70.2148L1067.54 87.6758C1068.39 88.6133 1068.82 89.6875 1068.82 90.8984C1068.82 91.4453 1068.75 92.0117 1068.59 92.5977L1061.38 117.559C1061.07 118.77 1060.52 119.941 1059.74 121.074C1059 122.207 1058 123.145 1056.75 123.887C1055.5 124.629 1053.98 125 1052.18 125H1025.35C1023.67 125 1022.55 124.453 1022.01 123.359C1021.7 122.734 1021.54 122.09 1021.54 121.426C1021.54 120.957 1021.62 120.469 1021.77 119.961L1027.63 99.5117H1040.17L1037.12 110.176H1051.71L1054.94 98.75C1054.98 98.5938 1055 98.4375 1055 98.2812C1055 97.9688 1054.88 97.6758 1054.64 97.4023L1034.55 79.1797C1033.88 78.4766 1033.55 77.6562 1033.55 76.7188C1033.55 76.3281 1033.61 75.8984 1033.73 75.4297L1040.76 50.8789C1041.46 48.3789 1042.46 46.6016 1043.75 45.5469C1045.07 44.4531 1046.66 43.9062 1048.49 43.9062H1074.68C1076.75 43.9062 1078.3 44.668 1079.31 46.1914C1079.86 47.0117 1080.13 48.0664 1080.13 49.3555C1080.13 50.4883 1079.92 51.7969 1079.49 53.2812L1075.45 67.4023H1062.91L1065.37 58.7305H1050.37ZM1086.99 110.176H1103.22L1098.94 125H1074.51C1072.44 125 1070.88 124.258 1069.82 122.773C1069.16 121.836 1068.82 120.762 1068.82 119.551C1068.82 118.887 1068.92 118.184 1069.12 117.441L1087.87 51.9922C1088.57 49.6094 1089.37 47.8516 1090.27 46.7188C1091.17 45.5469 1092.14 44.7852 1093.2 44.4336C1094.29 44.082 1095.41 43.9062 1096.54 43.9062H1122.2L1117.93 58.7305H1101.7L1096.71 76.0742H1112.59L1104.1 89.668H1092.85L1086.99 110.176Z"
            fill="#F32324"
          />
          <path
            d="M120.027 89.668C120.301 90.6836 120.438 91.6211 120.438 92.4805C120.438 92.7539 120.398 93.2227 120.32 93.8867C120.242 94.5508 120.086 95.293 119.852 96.1133L115.223 112.344C114.285 115.586 113.133 118.125 111.766 119.961C110.398 121.797 108.914 123.105 107.312 123.887C105.711 124.629 104.051 125 102.332 125H70.8086L94.0703 43.9062H125.359C127.078 43.9062 128.543 44.3359 129.754 45.1953C130.965 46.0156 131.727 47.3438 132.039 49.1797C132.156 49.6875 132.215 50.2539 132.215 50.8789C132.215 52.4414 131.883 54.3359 131.219 56.5625L126.238 73.8477C126.121 74.3164 125.848 75.0391 125.418 76.0156C124.988 76.9922 124.383 77.9883 123.602 79.0039C122.859 79.9805 121.922 80.7422 120.789 81.2891C119.656 81.7578 118.543 82.1875 117.449 82.5781C116.355 82.9297 115.457 83.2031 114.754 83.3984L113.582 83.6914L114.461 84.2188C115.008 84.5703 115.672 85.0391 116.453 85.625C117.234 86.1719 117.957 86.7969 118.621 87.5C119.285 88.2031 119.754 88.9258 120.027 89.668ZM111.473 76.0742L116.453 58.7305H103.914L98.9336 76.0742H111.473ZM101.746 110.176L107.605 89.668H95.0664L89.207 110.176H101.746ZM139.246 110.176H155.477L151.199 125H126.766C124.695 125 123.133 124.258 122.078 122.773C121.414 121.836 121.082 120.762 121.082 119.551C121.082 118.887 121.18 118.184 121.375 117.441L140.125 51.9922C140.828 49.6094 141.629 47.8516 142.527 46.7188C143.426 45.5469 144.402 44.7852 145.457 44.4336C146.551 44.082 147.664 43.9062 148.797 43.9062H174.461L170.184 58.7305H153.953L148.973 76.0742H164.852L156.355 89.668H145.105L139.246 110.176ZM208.738 43.9062H223.855L195.203 89.1406L184.949 125H169.188L179.441 89.3164L176.805 43.9062H191.922L192.625 70.8594L208.738 43.9062ZM210.32 125C208.367 125 206.902 124.297 205.926 122.891C205.34 122.07 205.047 121.094 205.047 119.961C205.047 119.141 205.184 118.242 205.457 117.266L224.148 52.0508C224.969 49.1602 226.258 47.0898 228.016 45.8398C229.773 44.5508 231.629 43.9062 233.582 43.9062H260.125C262.078 43.9062 263.562 44.5312 264.578 45.7812C265.125 46.4844 265.398 47.4414 265.398 48.6523C265.398 49.6289 265.223 50.7617 264.871 52.0508L246.18 117.266C245.477 119.648 244.227 121.543 242.43 122.949C240.672 124.316 238.816 125 236.863 125H210.32ZM234.109 110.176L248.816 58.7305H236.336L221.629 110.176H234.109ZM288.777 87.6758L301.316 43.9062H313.621L290.359 125H278.055L278.172 87.793L277.527 79.4141L274.422 88.4375L263.934 125H251.629L274.891 43.9062H288.016L288.777 87.6758ZM298.035 125L321.297 43.9062H352.82C354.5 43.9062 355.926 44.2969 357.098 45.0781C358.27 45.8594 359.012 47.1289 359.324 48.8867C359.441 49.3945 359.5 49.9609 359.5 50.5859C359.5 52.0312 359.188 53.7891 358.562 55.8594L341.98 113.75C340.848 117.656 339.129 120.508 336.824 122.305C334.52 124.102 331.863 125 328.855 125H298.035ZM328.914 110.176L343.621 58.7305H331.141L316.434 110.176H328.914ZM385.457 125L404.441 58.7305H393.602L397.879 43.9062H435.262L430.984 58.7305H420.203L401.219 125H385.457ZM458.758 76.0742L468.016 43.9062H482.137L458.875 125H444.754L454.891 89.668H442.41L432.273 125H418.152L441.414 43.9062H455.535L446.277 76.0742H458.758ZM486.59 110.176H502.82L498.543 125H474.109C472.039 125 470.477 124.258 469.422 122.773C468.758 121.836 468.426 120.762 468.426 119.551C468.426 118.887 468.523 118.184 468.719 117.441L487.469 51.9922C488.172 49.6094 488.973 47.8516 489.871 46.7188C490.77 45.5469 491.746 44.7852 492.801 44.4336C493.895 44.082 495.008 43.9062 496.141 43.9062H521.805L517.527 58.7305H501.297L496.316 76.0742H512.195L503.699 89.668H492.449L486.59 110.176ZM608.289 42.6172C608.172 43.0078 608.113 43.3594 608.113 43.6719C608.113 44.4922 608.406 45.1953 608.992 45.7812L637.059 71.2695C638.27 72.4805 638.875 73.9062 638.875 75.5469C638.875 76.2109 638.758 76.9336 638.523 77.7148L628.445 112.988C627.625 115.801 626.414 118.086 624.812 119.844C623.211 121.602 621.395 122.91 619.363 123.77C617.332 124.59 615.203 125 612.977 125H581.688C579.461 125 577.488 124.57 575.77 123.711C574.051 122.852 572.84 121.406 572.137 119.375C571.863 118.555 571.727 117.637 571.727 116.621C571.727 115.098 572.02 113.32 572.605 111.289L579.285 88.0859H597.391L591.238 108.77H611.805L618.426 86.3867C618.543 86.0352 618.602 85.6836 618.602 85.332C618.602 84.5117 618.27 83.8086 617.605 83.2227L589.773 59.1406C588.523 57.9297 587.898 56.5039 587.898 54.8633C587.898 54.1602 588.016 53.418 588.25 52.6367L597.508 20.4688C598.133 18.1641 599.109 16.0547 600.438 14.1406C601.805 12.2266 603.68 10.7031 606.062 9.57031C608.445 8.4375 611.57 7.87109 615.438 7.87109H645.438C647.742 7.87109 649.695 8.37891 651.297 9.39453C652.938 10.4102 654.012 12.0508 654.52 14.3164C654.676 14.9805 654.754 15.7227 654.754 16.543C654.754 18.4961 654.344 20.8398 653.523 23.5742L648.309 41.7969H630.203L635.359 24.1016H613.738L608.289 42.6172ZM609.988 146.211C615.73 146.211 621.219 145.41 626.453 143.809C631.688 142.246 636.531 140.039 640.984 137.188H654.52C648.66 142.578 641.922 146.797 634.305 149.844C626.727 152.891 618.641 154.414 610.047 154.414C600.984 154.414 592.488 152.734 584.559 149.375C576.668 146.055 569.734 141.445 563.758 135.547C557.781 129.688 553.113 122.891 549.754 115.156C546.395 107.422 544.695 99.082 544.656 90.1367C544.734 83.8867 545.574 77.9883 547.176 72.4414C549.129 65.6836 552.996 58.2227 558.777 50.0586C564.598 41.8945 573.641 35.3516 585.906 30.4297L582.918 40.8594C573.895 45.7422 567.371 51.4062 563.348 57.8516C559.324 64.2578 556.609 69.8633 555.203 74.668C553.797 79.5508 553.074 84.707 553.035 90.1367C553.035 97.9492 554.5 105.234 557.43 111.992C560.398 118.711 564.48 124.629 569.676 129.746C574.91 134.902 580.965 138.926 587.84 141.816C594.754 144.746 602.137 146.211 609.988 146.211ZM635.77 125L659.031 43.9062H691.316C693.66 43.9062 695.418 44.7266 696.59 46.3672C697.332 47.4219 697.703 48.6328 697.703 50C697.703 50.7422 697.586 51.543 697.352 52.4023L689.09 81.1719C688.426 83.5156 687.02 85.5273 684.871 87.207C682.762 88.8477 680.535 89.668 678.191 89.668H660.027L649.891 125H635.77ZM676.434 76.0742L681.414 58.7305H668.875L663.895 76.0742H676.434ZM704.207 110.176H720.438L716.16 125H691.727C689.656 125 688.094 124.258 687.039 122.773C686.375 121.836 686.043 120.762 686.043 119.551C686.043 118.887 686.141 118.184 686.336 117.441L705.086 51.9922C705.789 49.6094 706.59 47.8516 707.488 46.7188C708.387 45.5469 709.363 44.7852 710.418 44.4336C711.512 44.082 712.625 43.9062 713.758 43.9062H739.422L735.145 58.7305H718.914L713.934 76.0742H729.812L721.316 89.668H710.066L704.207 110.176ZM742.176 110.176H756.59L759.637 99.5117H773.055L768.543 115.098C767.84 117.598 766.902 119.57 765.73 121.016C764.559 122.461 763.23 123.496 761.746 124.121C760.301 124.707 758.797 125 757.234 125H732.332C730.77 125 729.422 124.707 728.289 124.121C727.195 123.496 726.453 122.461 726.062 121.016C725.945 120.547 725.887 120 725.887 119.375C725.887 118.203 726.121 116.777 726.59 115.098L744.285 53.5156C744.988 51.0938 745.906 49.1797 747.039 47.7734C748.172 46.3672 749.441 45.3711 750.848 44.7852C752.293 44.1992 753.777 43.9062 755.301 43.9062H780.73C782.254 43.9062 783.543 44.1992 784.598 44.7852C785.691 45.3711 786.414 46.3672 786.766 47.7734C786.883 48.2422 786.941 48.7695 786.941 49.3555C786.941 50.5273 786.707 51.9141 786.238 53.5156L782.02 68.2812H768.602L771.297 58.7305H756.883L742.176 110.176ZM826.316 43.9062H843.074L815.066 75.0195L818.875 125H802.117L799.422 92.3633L795.613 96.582L787.469 125H773.348L796.609 43.9062H810.73L803.816 68.0469L826.316 43.9062ZM861.707 43.9062L842.723 110.176H858.953L854.676 125H829.773C827.82 125 826.355 124.297 825.379 122.891C824.754 122.031 824.441 121.055 824.441 119.961C824.441 119.297 824.539 118.613 824.734 117.91L845.945 43.9062H861.707ZM880.457 110.176H896.688L892.41 125H867.977C865.906 125 864.344 124.258 863.289 122.773C862.625 121.836 862.293 120.762 862.293 119.551C862.293 118.887 862.391 118.184 862.586 117.441L881.336 51.9922C882.039 49.6094 882.84 47.8516 883.738 46.7188C884.637 45.5469 885.613 44.7852 886.668 44.4336C887.762 44.082 888.875 43.9062 890.008 43.9062H915.672L911.395 58.7305H895.164L890.184 76.0742H906.062L897.566 89.668H886.316L880.457 110.176ZM937.762 80.9375L952.703 43.9062H967.234L933.25 125H920.066L918.484 43.9062H934.832L933.133 90.8984L937.762 80.9375ZM969.52 110.176H985.75L981.473 125H957.039C954.969 125 953.406 124.258 952.352 122.773C951.688 121.836 951.355 120.762 951.355 119.551C951.355 118.887 951.453 118.184 951.648 117.441L970.398 51.9922C971.102 49.6094 971.902 47.8516 972.801 46.7188C973.699 45.5469 974.676 44.7852 975.73 44.4336C976.824 44.082 977.938 43.9062 979.07 43.9062H1004.73L1000.46 58.7305H984.227L979.246 76.0742H995.125L986.629 89.668H975.379L969.52 110.176ZM1032.04 83.75L1032.45 84.043C1032.57 84.082 1032.72 84.1406 1032.92 84.2188C1033.43 84.5703 1034.05 85.0195 1034.79 85.5664C1035.54 86.0742 1036.24 86.6406 1036.9 87.2656C1037.57 87.8906 1038.04 88.4961 1038.31 89.082C1038.62 89.9414 1038.78 90.8398 1038.78 91.7773C1038.78 92.0898 1038.74 92.6367 1038.66 93.418C1038.58 94.1602 1038.33 95.293 1037.9 96.8164L1029.81 125H1015.69L1025.83 89.668H1013.35L1003.21 125H989.09L1012.35 43.9062H1043.99C1045.67 43.9062 1047.08 44.3164 1048.21 45.1367C1049.34 45.918 1050.07 47.2266 1050.38 49.0625C1050.46 49.4922 1050.5 49.9609 1050.5 50.4688C1050.5 52.1094 1050.16 54.082 1049.5 56.3867L1044.23 74.7266C1044.03 75.3125 1043.72 76.0352 1043.29 76.8945C1042.9 77.7148 1042.39 78.5156 1041.77 79.2969C1041.14 80.0391 1040.4 80.625 1039.54 81.0547C1037.51 81.9531 1035.75 82.6172 1034.27 83.0469L1032.04 83.75ZM1029.7 76.0742L1034.68 58.7305H1022.2L1017.21 76.0742H1029.7ZM1068.37 58.7305L1065.73 67.9297C1065.65 68.2031 1065.61 68.457 1065.61 68.6914C1065.61 69.2773 1065.83 69.7852 1066.26 70.2148L1085.54 87.6758C1086.39 88.6133 1086.82 89.6875 1086.82 90.8984C1086.82 91.4453 1086.75 92.0117 1086.59 92.5977L1079.38 117.559C1079.07 118.77 1078.52 119.941 1077.74 121.074C1077 122.207 1076 123.145 1074.75 123.887C1073.5 124.629 1071.98 125 1070.18 125H1043.35C1041.67 125 1040.55 124.453 1040.01 123.359C1039.7 122.734 1039.54 122.09 1039.54 121.426C1039.54 120.957 1039.62 120.469 1039.77 119.961L1045.63 99.5117H1058.17L1055.12 110.176H1069.71L1072.94 98.75C1072.98 98.5938 1073 98.4375 1073 98.2812C1073 97.9688 1072.88 97.6758 1072.64 97.4023L1052.55 79.1797C1051.88 78.4766 1051.55 77.6562 1051.55 76.7188C1051.55 76.3281 1051.61 75.8984 1051.73 75.4297L1058.76 50.8789C1059.46 48.3789 1060.46 46.6016 1061.75 45.5469C1063.07 44.4531 1064.66 43.9062 1066.49 43.9062H1092.68C1094.75 43.9062 1096.3 44.668 1097.31 46.1914C1097.86 47.0117 1098.13 48.0664 1098.13 49.3555C1098.13 50.4883 1097.92 51.7969 1097.49 53.2812L1093.45 67.4023H1080.91L1083.37 58.7305H1068.37ZM1104.99 110.176H1121.22L1116.94 125H1092.51C1090.44 125 1088.88 124.258 1087.82 122.773C1087.16 121.836 1086.82 120.762 1086.82 119.551C1086.82 118.887 1086.92 118.184 1087.12 117.441L1105.87 51.9922C1106.57 49.6094 1107.37 47.8516 1108.27 46.7188C1109.17 45.5469 1110.14 44.7852 1111.2 44.4336C1112.29 44.082 1113.41 43.9062 1114.54 43.9062H1140.2L1135.93 58.7305H1119.7L1114.71 76.0742H1130.59L1122.1 89.668H1110.85L1104.99 110.176Z"
            fill="#313F9B"
          />
          <path
            d="M111.027 89.668C111.301 90.6836 111.438 91.6211 111.438 92.4805C111.438 92.7539 111.398 93.2227 111.32 93.8867C111.242 94.5508 111.086 95.293 110.852 96.1133L106.223 112.344C105.285 115.586 104.133 118.125 102.766 119.961C101.398 121.797 99.9141 123.105 98.3125 123.887C96.7109 124.629 95.0508 125 93.332 125H61.8086L85.0703 43.9062H116.359C118.078 43.9062 119.543 44.3359 120.754 45.1953C121.965 46.0156 122.727 47.3438 123.039 49.1797C123.156 49.6875 123.215 50.2539 123.215 50.8789C123.215 52.4414 122.883 54.3359 122.219 56.5625L117.238 73.8477C117.121 74.3164 116.848 75.0391 116.418 76.0156C115.988 76.9922 115.383 77.9883 114.602 79.0039C113.859 79.9805 112.922 80.7422 111.789 81.2891C110.656 81.7578 109.543 82.1875 108.449 82.5781C107.355 82.9297 106.457 83.2031 105.754 83.3984L104.582 83.6914L105.461 84.2188C106.008 84.5703 106.672 85.0391 107.453 85.625C108.234 86.1719 108.957 86.7969 109.621 87.5C110.285 88.2031 110.754 88.9258 111.027 89.668ZM102.473 76.0742L107.453 58.7305H94.9141L89.9336 76.0742H102.473ZM92.7461 110.176L98.6055 89.668H86.0664L80.207 110.176H92.7461ZM130.246 110.176H146.477L142.199 125H117.766C115.695 125 114.133 124.258 113.078 122.773C112.414 121.836 112.082 120.762 112.082 119.551C112.082 118.887 112.18 118.184 112.375 117.441L131.125 51.9922C131.828 49.6094 132.629 47.8516 133.527 46.7188C134.426 45.5469 135.402 44.7852 136.457 44.4336C137.551 44.082 138.664 43.9062 139.797 43.9062H165.461L161.184 58.7305H144.953L139.973 76.0742H155.852L147.355 89.668H136.105L130.246 110.176ZM199.738 43.9062H214.855L186.203 89.1406L175.949 125H160.188L170.441 89.3164L167.805 43.9062H182.922L183.625 70.8594L199.738 43.9062ZM201.32 125C199.367 125 197.902 124.297 196.926 122.891C196.34 122.07 196.047 121.094 196.047 119.961C196.047 119.141 196.184 118.242 196.457 117.266L215.148 52.0508C215.969 49.1602 217.258 47.0898 219.016 45.8398C220.773 44.5508 222.629 43.9062 224.582 43.9062H251.125C253.078 43.9062 254.562 44.5312 255.578 45.7812C256.125 46.4844 256.398 47.4414 256.398 48.6523C256.398 49.6289 256.223 50.7617 255.871 52.0508L237.18 117.266C236.477 119.648 235.227 121.543 233.43 122.949C231.672 124.316 229.816 125 227.863 125H201.32ZM225.109 110.176L239.816 58.7305H227.336L212.629 110.176H225.109ZM279.777 87.6758L292.316 43.9062H304.621L281.359 125H269.055L269.172 87.793L268.527 79.4141L265.422 88.4375L254.934 125H242.629L265.891 43.9062H279.016L279.777 87.6758ZM289.035 125L312.297 43.9062H343.82C345.5 43.9062 346.926 44.2969 348.098 45.0781C349.27 45.8594 350.012 47.1289 350.324 48.8867C350.441 49.3945 350.5 49.9609 350.5 50.5859C350.5 52.0312 350.188 53.7891 349.562 55.8594L332.98 113.75C331.848 117.656 330.129 120.508 327.824 122.305C325.52 124.102 322.863 125 319.855 125H289.035ZM319.914 110.176L334.621 58.7305H322.141L307.434 110.176H319.914ZM376.457 125L395.441 58.7305H384.602L388.879 43.9062H426.262L421.984 58.7305H411.203L392.219 125H376.457ZM449.758 76.0742L459.016 43.9062H473.137L449.875 125H435.754L445.891 89.668H433.41L423.273 125H409.152L432.414 43.9062H446.535L437.277 76.0742H449.758ZM477.59 110.176H493.82L489.543 125H465.109C463.039 125 461.477 124.258 460.422 122.773C459.758 121.836 459.426 120.762 459.426 119.551C459.426 118.887 459.523 118.184 459.719 117.441L478.469 51.9922C479.172 49.6094 479.973 47.8516 480.871 46.7188C481.77 45.5469 482.746 44.7852 483.801 44.4336C484.895 44.082 486.008 43.9062 487.141 43.9062H512.805L508.527 58.7305H492.297L487.316 76.0742H503.195L494.699 89.668H483.449L477.59 110.176ZM599.289 42.6172C599.172 43.0078 599.113 43.3594 599.113 43.6719C599.113 44.4922 599.406 45.1953 599.992 45.7812L628.059 71.2695C629.27 72.4805 629.875 73.9062 629.875 75.5469C629.875 76.2109 629.758 76.9336 629.523 77.7148L619.445 112.988C618.625 115.801 617.414 118.086 615.812 119.844C614.211 121.602 612.395 122.91 610.363 123.77C608.332 124.59 606.203 125 603.977 125H572.688C570.461 125 568.488 124.57 566.77 123.711C565.051 122.852 563.84 121.406 563.137 119.375C562.863 118.555 562.727 117.637 562.727 116.621C562.727 115.098 563.02 113.32 563.605 111.289L570.285 88.0859H588.391L582.238 108.77H602.805L609.426 86.3867C609.543 86.0352 609.602 85.6836 609.602 85.332C609.602 84.5117 609.27 83.8086 608.605 83.2227L580.773 59.1406C579.523 57.9297 578.898 56.5039 578.898 54.8633C578.898 54.1602 579.016 53.418 579.25 52.6367L588.508 20.4688C589.133 18.1641 590.109 16.0547 591.438 14.1406C592.805 12.2266 594.68 10.7031 597.062 9.57031C599.445 8.4375 602.57 7.87109 606.438 7.87109H636.438C638.742 7.87109 640.695 8.37891 642.297 9.39453C643.938 10.4102 645.012 12.0508 645.52 14.3164C645.676 14.9805 645.754 15.7227 645.754 16.543C645.754 18.4961 645.344 20.8398 644.523 23.5742L639.309 41.7969H621.203L626.359 24.1016H604.738L599.289 42.6172ZM600.988 146.211C606.73 146.211 612.219 145.41 617.453 143.809C622.688 142.246 627.531 140.039 631.984 137.188H645.52C639.66 142.578 632.922 146.797 625.305 149.844C617.727 152.891 609.641 154.414 601.047 154.414C591.984 154.414 583.488 152.734 575.559 149.375C567.668 146.055 560.734 141.445 554.758 135.547C548.781 129.688 544.113 122.891 540.754 115.156C537.395 107.422 535.695 99.082 535.656 90.1367C535.734 83.8867 536.574 77.9883 538.176 72.4414C540.129 65.6836 543.996 58.2227 549.777 50.0586C555.598 41.8945 564.641 35.3516 576.906 30.4297L573.918 40.8594C564.895 45.7422 558.371 51.4062 554.348 57.8516C550.324 64.2578 547.609 69.8633 546.203 74.668C544.797 79.5508 544.074 84.707 544.035 90.1367C544.035 97.9492 545.5 105.234 548.43 111.992C551.398 118.711 555.48 124.629 560.676 129.746C565.91 134.902 571.965 138.926 578.84 141.816C585.754 144.746 593.137 146.211 600.988 146.211ZM626.77 125L650.031 43.9062H682.316C684.66 43.9062 686.418 44.7266 687.59 46.3672C688.332 47.4219 688.703 48.6328 688.703 50C688.703 50.7422 688.586 51.543 688.352 52.4023L680.09 81.1719C679.426 83.5156 678.02 85.5273 675.871 87.207C673.762 88.8477 671.535 89.668 669.191 89.668H651.027L640.891 125H626.77ZM667.434 76.0742L672.414 58.7305H659.875L654.895 76.0742H667.434ZM695.207 110.176H711.438L707.16 125H682.727C680.656 125 679.094 124.258 678.039 122.773C677.375 121.836 677.043 120.762 677.043 119.551C677.043 118.887 677.141 118.184 677.336 117.441L696.086 51.9922C696.789 49.6094 697.59 47.8516 698.488 46.7188C699.387 45.5469 700.363 44.7852 701.418 44.4336C702.512 44.082 703.625 43.9062 704.758 43.9062H730.422L726.145 58.7305H709.914L704.934 76.0742H720.812L712.316 89.668H701.066L695.207 110.176ZM733.176 110.176H747.59L750.637 99.5117H764.055L759.543 115.098C758.84 117.598 757.902 119.57 756.73 121.016C755.559 122.461 754.23 123.496 752.746 124.121C751.301 124.707 749.797 125 748.234 125H723.332C721.77 125 720.422 124.707 719.289 124.121C718.195 123.496 717.453 122.461 717.062 121.016C716.945 120.547 716.887 120 716.887 119.375C716.887 118.203 717.121 116.777 717.59 115.098L735.285 53.5156C735.988 51.0938 736.906 49.1797 738.039 47.7734C739.172 46.3672 740.441 45.3711 741.848 44.7852C743.293 44.1992 744.777 43.9062 746.301 43.9062H771.73C773.254 43.9062 774.543 44.1992 775.598 44.7852C776.691 45.3711 777.414 46.3672 777.766 47.7734C777.883 48.2422 777.941 48.7695 777.941 49.3555C777.941 50.5273 777.707 51.9141 777.238 53.5156L773.02 68.2812H759.602L762.297 58.7305H747.883L733.176 110.176ZM817.316 43.9062H834.074L806.066 75.0195L809.875 125H793.117L790.422 92.3633L786.613 96.582L778.469 125H764.348L787.609 43.9062H801.73L794.816 68.0469L817.316 43.9062ZM852.707 43.9062L833.723 110.176H849.953L845.676 125H820.773C818.82 125 817.355 124.297 816.379 122.891C815.754 122.031 815.441 121.055 815.441 119.961C815.441 119.297 815.539 118.613 815.734 117.91L836.945 43.9062H852.707ZM871.457 110.176H887.688L883.41 125H858.977C856.906 125 855.344 124.258 854.289 122.773C853.625 121.836 853.293 120.762 853.293 119.551C853.293 118.887 853.391 118.184 853.586 117.441L872.336 51.9922C873.039 49.6094 873.84 47.8516 874.738 46.7188C875.637 45.5469 876.613 44.7852 877.668 44.4336C878.762 44.082 879.875 43.9062 881.008 43.9062H906.672L902.395 58.7305H886.164L881.184 76.0742H897.062L888.566 89.668H877.316L871.457 110.176ZM928.762 80.9375L943.703 43.9062H958.234L924.25 125H911.066L909.484 43.9062H925.832L924.133 90.8984L928.762 80.9375ZM960.52 110.176H976.75L972.473 125H948.039C945.969 125 944.406 124.258 943.352 122.773C942.688 121.836 942.355 120.762 942.355 119.551C942.355 118.887 942.453 118.184 942.648 117.441L961.398 51.9922C962.102 49.6094 962.902 47.8516 963.801 46.7188C964.699 45.5469 965.676 44.7852 966.73 44.4336C967.824 44.082 968.938 43.9062 970.07 43.9062H995.734L991.457 58.7305H975.227L970.246 76.0742H986.125L977.629 89.668H966.379L960.52 110.176ZM1023.04 83.75L1023.45 84.043C1023.57 84.082 1023.72 84.1406 1023.92 84.2188C1024.43 84.5703 1025.05 85.0195 1025.79 85.5664C1026.54 86.0742 1027.24 86.6406 1027.9 87.2656C1028.57 87.8906 1029.04 88.4961 1029.31 89.082C1029.62 89.9414 1029.78 90.8398 1029.78 91.7773C1029.78 92.0898 1029.74 92.6367 1029.66 93.418C1029.58 94.1602 1029.33 95.293 1028.9 96.8164L1020.81 125H1006.69L1016.83 89.668H1004.35L994.211 125H980.09L1003.35 43.9062H1034.99C1036.67 43.9062 1038.08 44.3164 1039.21 45.1367C1040.34 45.918 1041.07 47.2266 1041.38 49.0625C1041.46 49.4922 1041.5 49.9609 1041.5 50.4688C1041.5 52.1094 1041.16 54.082 1040.5 56.3867L1035.23 74.7266C1035.03 75.3125 1034.72 76.0352 1034.29 76.8945C1033.9 77.7148 1033.39 78.5156 1032.77 79.2969C1032.14 80.0391 1031.4 80.625 1030.54 81.0547C1028.51 81.9531 1026.75 82.6172 1025.27 83.0469L1023.04 83.75ZM1020.7 76.0742L1025.68 58.7305H1013.2L1008.21 76.0742H1020.7ZM1059.37 58.7305L1056.73 67.9297C1056.65 68.2031 1056.61 68.457 1056.61 68.6914C1056.61 69.2773 1056.83 69.7852 1057.26 70.2148L1076.54 87.6758C1077.39 88.6133 1077.82 89.6875 1077.82 90.8984C1077.82 91.4453 1077.75 92.0117 1077.59 92.5977L1070.38 117.559C1070.07 118.77 1069.52 119.941 1068.74 121.074C1068 122.207 1067 123.145 1065.75 123.887C1064.5 124.629 1062.98 125 1061.18 125H1034.35C1032.67 125 1031.55 124.453 1031.01 123.359C1030.7 122.734 1030.54 122.09 1030.54 121.426C1030.54 120.957 1030.62 120.469 1030.77 119.961L1036.63 99.5117H1049.17L1046.12 110.176H1060.71L1063.94 98.75C1063.98 98.5938 1064 98.4375 1064 98.2812C1064 97.9688 1063.88 97.6758 1063.64 97.4023L1043.55 79.1797C1042.88 78.4766 1042.55 77.6562 1042.55 76.7188C1042.55 76.3281 1042.61 75.8984 1042.73 75.4297L1049.76 50.8789C1050.46 48.3789 1051.46 46.6016 1052.75 45.5469C1054.07 44.4531 1055.66 43.9062 1057.49 43.9062H1083.68C1085.75 43.9062 1087.3 44.668 1088.31 46.1914C1088.86 47.0117 1089.13 48.0664 1089.13 49.3555C1089.13 50.4883 1088.92 51.7969 1088.49 53.2812L1084.45 67.4023H1071.91L1074.37 58.7305H1059.37ZM1095.99 110.176H1112.22L1107.94 125H1083.51C1081.44 125 1079.88 124.258 1078.82 122.773C1078.16 121.836 1077.82 120.762 1077.82 119.551C1077.82 118.887 1077.92 118.184 1078.12 117.441L1096.87 51.9922C1097.57 49.6094 1098.37 47.8516 1099.27 46.7188C1100.17 45.5469 1101.14 44.7852 1102.2 44.4336C1103.29 44.082 1104.41 43.9062 1105.54 43.9062H1131.2L1126.93 58.7305H1110.7L1105.71 76.0742H1121.59L1113.1 89.668H1101.85L1095.99 110.176Z"
            fill="white"
          />
        </svg>
      </div>
      <div class="flex-1 lg:gap-1 flex flex-col lg:flex-row text-center md:text-left">
        <span class="font-semibold">Join our online hackathon!</span>
        <span>June 7 - 9, 2024</span>
      </div>
      <div class="flex gap-2">
        <a href="https://speckle.systems/blog/hackathon/" target="_blank">
          <button
            class="bg-white/90 hover:bg-white border border-transparent rounded py-1 px-2.5 text-[#27272a] font-semibold"
          >
            Learn more
          </button>
        </a>

        <button
          class="bg-transparent hover:bg-white/10 border border-white rounded py-1 px-2.5 text-white"
        >
          Close
        </button>
      </div>
    </div>

    <div
      v-if="!showEmptyState"
      class="flex flex-col space-y-2 md:flex-row md:items-center mb-8 pt-4"
    >
      <h1 class="h4 font-bold">Projects</h1>

      <div
        class="flex flex-col space-y-2 sm:space-y-0 sm:flex-row sm:items-center sm:space-x-2 grow md:justify-end"
      >
        <FormTextInput
          v-model="search"
          name="modelsearch"
          :show-label="false"
          placeholder="Search"
          color="foundation"
          wrapper-classes="grow md:grow-0 md:w-60 hover:shadow rounded-md outline outline-2 outline-primary-muted"
          :show-clear="!!search"
          @change="updateSearchImmediately"
          @update:model-value="updateDebouncedSearch"
        ></FormTextInput>
        <div class="flex items-center space-x-2">
          <FormSelectProjectRoles
            v-if="!showEmptyState"
            v-model="selectedRoles"
            class="w-56 grow md:grow-0"
            fixed-height
          />
          <FormButton
            v-if="!isGuest"
            :icon-left="PlusIcon"
            @click="openNewProject = true"
          >
            New
          </FormButton>
        </div>
      </div>
    </div>
    <CommonLoadingBar :loading="showLoadingBar" class="my-2" />
    <ProjectsDashboardEmptyState
      v-if="showEmptyState"
      @create-project="openNewProject = true"
    />
    <template v-else-if="projects?.items?.length">
      <ProjectsDashboardFilled :projects="projects" />
      <InfiniteLoading
        :settings="{ identifier: infiniteLoaderId }"
        @infinite="infiniteLoad"
      />
    </template>
    <CommonEmptySearchState v-else-if="!showLoadingBar" @clear-search="clearSearch" />
    <ProjectsAddDialog v-model:open="openNewProject" />
  </div>
</template>
<script setup lang="ts">
import {
  useApolloClient,
  useQuery,
  useQueryLoading,
  useSubscription
} from '@vue/apollo-composable'
import { projectsDashboardQuery } from '~~/lib/projects/graphql/queries'
import { PlusIcon } from '@heroicons/vue/24/solid'
import { debounce } from 'lodash-es'
import { graphql } from '~~/lib/common/generated/gql'
import {
  getCacheId,
  evictObjectFields,
  modifyObjectFields
} from '~~/lib/common/helpers/graphql'
import type { User, UserProjectsArgs } from '~~/lib/common/generated/gql/graphql'
import { UserProjectsUpdatedMessageType } from '~~/lib/common/generated/gql/graphql'
import { ToastNotificationType, useGlobalToast } from '~~/lib/common/composables/toast'
import { projectRoute } from '~~/lib/common/helpers/route'
import { useActiveUser } from '~~/lib/auth/composables/activeUser'
import type { InfiniteLoaderState } from '~~/lib/global/helpers/components'
import type { Nullable, Optional, StreamRoles } from '@speckle/shared'
import { useSynchronizedCookie } from '~~/lib/common/composables/reactiveCookie'

const onUserProjectsUpdateSubscription = graphql(`
  subscription OnUserProjectsUpdate {
    userProjectsUpdated {
      type
      id
      project {
        ...ProjectDashboardItem
      }
    }
  }
`)

const logger = useLogger()

const infiniteLoaderId = ref('')
const cursor = ref(null as Nullable<string>)
const selectedRoles = ref(undefined as Optional<StreamRoles[]>)
const search = ref('')
const debouncedSearch = ref('')
const openNewProject = ref(false)
const showLoadingBar = ref(false)

const { activeUser, isGuest } = useActiveUser()
const { triggerNotification } = useGlobalToast()
const areQueriesLoading = useQueryLoading()
const apollo = useApolloClient().client
const {
  result: projectsPanelResult,
  fetchMore: fetchMoreProjects,
  onResult: onProjectsResult,
  variables: projectsVariables
} = useQuery(projectsDashboardQuery, () => ({
  filter: {
    search: (debouncedSearch.value || '').trim() || null,
    onlyWithRoles: selectedRoles.value?.length ? selectedRoles.value : null
  }
}))

onProjectsResult((res) => {
  cursor.value = res.data?.activeUser?.projects.cursor || null
  infiniteLoaderId.value = JSON.stringify(projectsVariables.value?.filter || {})
})

const { onResult: onUserProjectsUpdate } = useSubscription(
  onUserProjectsUpdateSubscription
)

const projects = computed(() => projectsPanelResult.value?.activeUser?.projects)
const showEmptyState = computed(() => {
  const isFiltering =
    projectsVariables.value?.filter?.onlyWithRoles?.length ||
    projectsVariables.value?.filter?.search?.length
  if (isFiltering) return false

  return projects.value && !projects.value.items.length
})

const moreToLoad = computed(
  () =>
    (!projects.value || projects.value.items.length < projects.value.totalCount) &&
    cursor.value
)

const updateDebouncedSearch = debounce(() => {
  debouncedSearch.value = search.value.trim()
}, 1000)

const updateSearchImmediately = () => {
  updateDebouncedSearch.cancel()
  debouncedSearch.value = search.value.trim()
}

const onDismissNewSpeckleBanner = () => {
  hasDismissedNewSpeckleBanner.value = true
}

onUserProjectsUpdate((res) => {
  const activeUserId = activeUser.value?.id
  const event = res.data?.userProjectsUpdated

  if (!event) return
  if (!activeUserId) return

  const isNewProject = event.type === UserProjectsUpdatedMessageType.Added
  const incomingProject = event.project
  const cache = apollo.cache

  if (isNewProject && incomingProject) {
    // Add to User.projects where possible
    modifyObjectFields<UserProjectsArgs, User['projects']>(
      cache,
      getCacheId('User', activeUserId),
      (fieldName, variables, value, { ref }) => {
        if (fieldName !== 'projects') return
        if (variables.filter?.search?.length) return
        if (variables.filter?.onlyWithRoles?.length) {
          const roles = variables.filter.onlyWithRoles
          if (!roles.includes(incomingProject.role || '')) return
        }

        return {
          ...value,
          items: [ref('Project', incomingProject.id), ...(value.items || [])],
          totalCount: (value.totalCount || 0) + 1
        }
      }
    )

    // Elsewhere - just evict fields directly
    evictObjectFields<UserProjectsArgs, User['projects']>(
      cache,
      getCacheId('User', activeUserId),
      (fieldName, variables) => {
        if (fieldName !== 'projects') return false
        if (variables.filter?.search?.length) return true

        return false
      }
    )
  }

  if (!isNewProject) {
    // Evict old project from cache entirely to remove it from all searches
    cache.evict({
      id: getCacheId('Project', event.id)
    })
  }

  // Emit toast notification
  triggerNotification({
    type: ToastNotificationType.Info,
    title: isNewProject ? 'New project added' : 'A project has been removed',
    cta:
      isNewProject && incomingProject
        ? {
            url: projectRoute(incomingProject.id),
            title: 'View project'
          }
        : undefined
  })
})

const infiniteLoad = async (state: InfiniteLoaderState) => {
  if (!moreToLoad.value) return state.complete()

  try {
    await fetchMoreProjects({
      variables: {
        cursor: cursor.value
      }
    })
  } catch (e) {
    logger.error(e)
    state.error()
    return
  }

  state.loaded()
  if (!moreToLoad.value) {
    state.complete()
  }
}

watch(search, (newVal) => {
  if (newVal) showLoadingBar.value = true
  else showLoadingBar.value = false
})

watch(areQueriesLoading, (newVal) => (showLoadingBar.value = newVal))

const hasCompletedChecklistV1 = useSynchronizedCookie<boolean>(
  `hasCompletedChecklistV1`,
  {
    default: () => false
  }
)

const hasDismissedChecklistTime = useSynchronizedCookie<string | undefined>(
  `hasDismissedChecklistTime`,
  { default: () => undefined }
)

const hasDismissedChecklistForever = useSynchronizedCookie<boolean | undefined>(
  `hasDismissedChecklistForever`,
  {
    default: () => false
  }
)

const hasDismissedChecklistTimeAgo = computed(() => {
  return (
    new Date().getTime() -
    new Date(hasDismissedChecklistTime.value || Date.now()).getTime()
  )
})

const hasDismissedNewSpeckleBanner = useSynchronizedCookie<boolean | undefined>(
  `hasDismissedNewSpeckleBanner`,
  { default: () => false }
)

const showChecklist = computed(() => {
  if (hasDismissedChecklistForever.value) return false
  if (hasCompletedChecklistV1.value) return false
  if (hasDismissedChecklistTime.value === undefined) return true
  if (
    hasDismissedChecklistTime.value !== undefined &&
    hasDismissedChecklistTimeAgo.value > 86400000 // 10_0000 // 86400000
  )
    return true
  return false
})

const showNewSpeckleBanner = computed(() => {
  if (hasDismissedNewSpeckleBanner.value) return false
  if (projectsPanelResult?.value?.activeUser?.projectInvites.length) return false

  return true
})

const clearSearch = () => {
  search.value = ''
  selectedRoles.value = []
  updateSearchImmediately()
}
</script>
